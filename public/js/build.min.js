var Player=Backbone.Model.extend({initialize:function(){this.listenTo(dispatcher,"turn:"+this.get("index"),this.onTurn)}});Array.prototype.clone=function(){var a,b=[];for(a=0;a<this.length;a++)b[a]=this[a].slice();return b};var AICache=function(){this.cache={},this.add=function(a,b){this.cache[a]=b},this.get=function(a){var b=this.cache[a];return null===b||void 0===b?null:b},this.clear=function(){this.cache={}}},ExpertAIPlayer=Player.extend({type:"ai",depth:8,initialize:function(){Player.prototype.initialize.call(this),this.set({opponentIndex:0===this.get("index")?1:0,cache:new AICache,boardController:new Board})},onTurn:function(a){dispatcher.trigger("loading:start");var b=a.get("id");this.getNextMove(a.get("board"),function(a){dispatcher.trigger("loading:stop"),dispatcher.trigger("play",a,this,b)}.bind(this))},getNextMove:function(a,b){var c=a.get("board").clone();this.get("cache").clear(),setTimeout(function(){this.minimax(c,!0,this.depth,-9e3,9e3);var a=this.get("choice");b(a)}.bind(this),100)},minimax:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=this.get("index"),p=this.get("opponentIndex"),q=b?o:p,r=this.get("boardController"),s=this.get("cache");if(r.set({board:a}),0===c||r.checkWin(o)||r.checkWin(p)||r.isFullBoard())return this.evaluate(r,c,q);if(f=r.getLegalMoves(),this.sortMoves(f),h=f.slice(),b){for(k=-9e3,l=0;l<h.length;l++)if(g=h[l],i=a.clone(),r.set({board:i}),r.play(g,q),n=r.hash(),m=s.get(n),null!==m){if(m>k&&(k=m,j=g),d=Math.max(d,k),d>=e)return this.set({choice:j}),k;f.splice(f.indexOf(g),1)}for(l=0;l<f.length&&(g=f[l],i=a.clone(),r.set({board:i}),r.play(g,q),n=r.hash(),m=s.get(n),null===m&&(m=this.minimax(i,!b,c-1,d,e),s.add(n,m)),m>k&&(k=m,j=g),d=Math.max(d,k),!(d>=e));l++);return this.set({choice:j}),k}for(k=9e3,l=0;l<h.length;l++)if(g=h[l],i=a.clone(),r.set({board:i}),r.play(g,q),n=r.hash(),m=s.get(n),null!==m){if(k>m&&(k=m,j=g),e=Math.min(e,k),d>=e)return this.set({choice:j}),k;f.splice(f.indexOf(g),1)}for(l=0;l<f.length&&(g=f[l],i=a.clone(),r.set({board:i}),r.play(g,q),n=r.hash(),m=s.get(n),null===m&&(m=this.minimax(i,!b,c-1,d,e),s.add(n,m)),k>m&&(k=m,j=g),e=Math.min(e,k),!(d>=e));l++);return this.set({choice:j}),k},sortMoves:function(a){a.sort(function(a,b){return 3===a?-1:3===b?1:4===a||2===a?-1:4===b||2===b?1:5===a||1===a?-1:5===b||1===b?1:-1})},evaluate:function(a,b,c){var d=this.get("index"),e=this.get("opponentIndex"),f=a.checkWin(d),g=a.checkWin(e),h=c===d?-b:b,i=a.getNbChains(d);return f?1e3+10*h+3*i:g?-1e3+10*h+3*i:3*i+h}}),HumanPlayer=Player.extend({onTurn:function(a){dispatcher.trigger("game:enable"),this.listenTo(dispatcher,"tile:click",function(b){dispatcher.trigger("play",b,this,a.get("id")),dispatcher.trigger("game:disable"),this.stopListening(dispatcher,"tile:click")}.bind(this))}}),Board=Backbone.Model.extend({defaults:{nbRows:6,nbCols:7},initialize:function(){this.initBoard(this.get("nbRows"),this.get("nbCols"))},initBoard:function(a,b){for(var c=[],d=0;a>d;d++)c.push([]);for(d=0;d<c.length;d++)for(var e=0;b>e;e++)c[d].push(-1);this.set({board:c})},clear:function(){for(var a=this.get("board"),b=0;b<a.length;b++)for(var c=0;c<a[b].length;c++)a[b][c]=-1},play:function(a,b){var c=this.findHighestEmptyTile(a);if(-1===c)throw new Error("Cannot play at this position");return this.get("board")[c][a]=b,[c,a]},findHighestEmptyTile:function(a){for(var b=this.get("board"),c=-1,d=0;d<b.length&&-1===b[d][a];d++)c=d;return c},getLegalMoves:function(){for(var a=[],b=0;b<this.get("nbCols");b++)-1!==this.findHighestEmptyTile(b)&&a.push(b);return a},isFullBoard:function(){for(var a=0;a<this.get("nbCols");a++)if(-1!==this.findHighestEmptyTile(a))return!1;return!0},isValidMove:function(a){return-1!==this.findHighestEmptyTile(a)},checkWin:function(a){var b,c,d,e,f=0,g=this.get("board"),h=this.get("nbRows"),i=this.get("nbCols");for(b=0;b<g.length;b++){for(c=0;c<g[b].length;c++)if(g[b][c]===a?f++:f=0,4===f)return!0;f=0}for(c=0;c<g[0].length;c++){for(b=0;b<g.length;b++)if(g[b][c]===a?f++:f=0,4===f)return!0;f=0}for(b=0;h>b;b++){for(d=0;h>b+d&&i>d;){if(g[b+d][d]===a?f++:f=0,4===f)return!0;d++}f=0}for(b=0;h>b;b++){for(d=0;b-d>=0&&i>d;){if(g[b-d][d]===a?f++:f=0,4===f)return!0;d++}f=0}for(b=0;h>b;b++){for(d=0,e=i-1;h>b+d&&e-d>=0;){if(g[b+d][e-d]===a?f++:f=0,4===f)return!0;d++}f=0}for(b=0;h>b;b++){for(d=0,e=i-1;b-d>=0&&e-d>=0;){if(g[b-d][e-d]===a?f++:f=0,4===f)return!0;d++}f=0}return!1},getNbChains:function(a){for(var b=0,c=this.get("nbRows"),d=this.get("nbCols"),e=this.get("board"),f=0;c>f;f++)for(var g=0;d>g;g++)for(var h=0;4>h;h++)c>f+h&&-1!==e[f+h][g]&&(e[f+h][g]===a?b++:e[f+h][g]!==a&&b--),d>g+h&&-1!==e[f][g+h]&&(e[f][g+h]===a?b++:e[f][g+h]!==a&&b--),d>g+h&&c>f+h&&-1!==e[f+h][g+h]&&(e[f+h][g+h]===a?b++:e[f+h][g+h]!==a&&b--),g-h>=0&&c>f+h&&-1!==e[f+h][g-h]&&(e[f+h][g-h]===a?b++:e[f+h][g-h]!==a&&b--);return b},getTile:function(a,b){return this.get("board")[a][b]},hash:function(){var a;return this.get("board").reduce(function(b,c){return b+=c.reduce(function(b,c){return a=-1===c?"x":c,b+=a},"")},"")}}),Game=Backbone.Model.extend({defaults:{turn:0,board:new Board,id:0},initialize:function(){this.listenTo(dispatcher,"game:start",this.start),this.listenTo(dispatcher,"game:restart",this.restart),this.listenTo(dispatcher,"view:updated",this.onPlayed),this.listenTo(dispatcher,"play",this.play),this.listenTo(dispatcher,"view:resized",function(){dispatcher.trigger("game:update",this.get("board"))}.bind(this))},nextPlayer:function(){this.set({turn:0===this.get("turn")?1:0})},onPlayed:function(){setTimeout(function(){var a=this.get("board"),b=this.get("turn");a.checkWin(b)?(dispatcher.trigger("win",b),dispatcher.trigger("game:disable")):(this.nextPlayer(),dispatcher.trigger("turn:"+this.get("turn"),this))}.bind(this),0)},restart:function(a){this.get("board").clear(),dispatcher.off("tile:click"),this.set({id:this.get("id")+1}),dispatcher.trigger("loading:stop",a),dispatcher.trigger("game:start",a)},start:function(a){dispatcher.trigger("game:init",this.get("board")),this.set({turn:0===a||1===a?a:0}),dispatcher.trigger("turn:"+this.get("turn"),this)},play:function(a,b,c){setTimeout(function(){var d=this.get("board"),e=b.get("index");if(d.isValidMove(a)&&e===this.get("turn")&&this.get("id")===c){var f=d.play(a,e);dispatcher.trigger("played",d,f[0],a,e)}}.bind(this),0)}}),tokens=["red","yellow"],colors={red:"#DD2222",yellow:"#DDDD22",maskBlue:"#222266"},BoardView=Backbone.View.extend({enabled:!1,tokens:tokens,initialize:function(){this.ctx=this.el.getContext("2d"),this.bgColor=$("body").css("backgroundColor"),window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)},this.listenTo(dispatcher,"played",function(a,b,c,d){this.update(a,b,c,d,function(){dispatcher.trigger("view:updated")})}.bind(this)),this.listenTo(dispatcher,"game:init",this.initBoard),this.listenTo(dispatcher,"game:enable",function(){this.enabled=!0}.bind(this)),this.listenTo(dispatcher,"game:disable",function(){this.enabled=!1}.bind(this)),window.onresize=function(){dispatcher.trigger("view:resized")},this.listenTo(dispatcher,"game:update",function(a){this.initBoard(a)}.bind(this))},initBoard:function(a){var b=this,c=this.$el.parent();this.width=c.width(),this.height=6*this.width/7,this.$el.attr("width",this.width),this.$el.attr("height",this.height),this.tileWidth=this.width/a.get("nbCols"),this.tileHeight=this.height/a.get("nbRows"),this.holeRadius=.3*this.tileWidth,this.pieceRadius=this.holeRadius+1,this.redPieceCanvas=this.renderOffScreen(2*this.pieceRadius,2*this.pieceRadius,function(a){b.drawPiece(a,b.pieceRadius,colors.red)}),this.yellowPieceCanvas=this.renderOffScreen(2*this.pieceRadius,2*this.pieceRadius,function(a){b.drawPiece(a,b.pieceRadius,colors.yellow)}),this.maskCache=this.renderOffScreen(this.width,this.height,function(c){b.renderMask(c,a,b.holeRadius,colors.maskBlue)}),this.render(a),this.canvasCache=this.renderOffScreen(this.width,this.height)},renderOffScreen:function(a,b,c){var d=document.createElement("canvas");return d.width=a,d.height=b,c&&c(d.getContext("2d")),d},render:function(a){var b,c,d=this.ctx,e=this.pieceRadius,f=this.tileWidth,g=a.get("nbRows"),h=a.get("nbCols");for(d.fillStyle=this.bgColor,d.fillRect(0,0,this.width,this.height),b=0;g>b;b++)for(c=0;h>c;c++){var i=a.getTile(b,c);if(-1!==i){var j=this.tokens[i],k=(f-2*e)/2;d.drawImage("red"===j?this.redPieceCanvas:"yellow"===j?this.yellowPieceCanvas:null,c*f+k,b*f+k)}}d.drawImage(this.maskCache,0,0)},renderMask:function(a,b,c,d){var e,f,g=b.get("nbCols"),h=b.get("nbRows"),i=this.tileWidth,j=this.width,k=this.height,l=(i-2*c)/2+c;for(a.save(),a.fillStyle=d,a.beginPath(),e=0;h>e;e++)for(f=0;g>f;f++)a.moveTo(f*i+l,e*i+l),a.arc(f*i+l,e*i+l,c,0,2*Math.PI);a.rect(j,0,-j,k),a.fill(),a.restore()},events:{click:"onTileClick"},drawPiece:function(a,b,c){a.save(),a.fillStyle=c,a.beginPath(),a.arc(b,b,b,0,2*Math.PI),a.fill(),a.restore()},onTileClick:function(a){if(this.enabled){var b=this.getMousePos(this.el,a)[0],c=Math.floor(b/this.tileWidth);dispatcher.trigger("tile:click",c)}},getMousePos:function(a,b){var c=a.getBoundingClientRect(),d=b.clientX-c.left,e=b.clientY-c.top;return[d,e]},getPieceBuffer:function(a){return 0===a?this.redPieceCanvas:1===a?this.yellowPieceCanvas:null},startAnimation:function(a,b,c,d,e,f){var g,h,i=this.tileWidth,j=this.pieceRadius,k=(i-2*j)/2,l=d*i+k,m=c*i+k,n=-2*j,o=0===e?this.redPieceCanvas:this.yellowPieceCanvas,p=this,q=window.requestAnimationFrame,r=b.get("nbRows"),s=b.get("nbCols"),t=this.width/150,u=this.renderOffScreen(this.width,this.height,function(a){for(var e=0;r>e;e++)for(var f=0;s>f;f++)if(c!==e||d!==f){var g=b.getTile(e,f);-1!==g&&a.drawImage(p.getPieceBuffer(g),i*f+k,i*e+k)}});h=Date.now(),function v(a,b){a>m&&(a=m),g=p.canvasCache.getContext("2d"),g.fillStyle=p.bgColor,g.fillRect(0,0,p.width,p.height),g.drawImage(u,0,0),g.drawImage(o,l,a),g.drawImage(p.maskCache,0,0),p.drawCanvas(p.canvasCache,p.el),m>a?q(function(){v(a+t*b,Date.now()-h),h=Date.now()}):f()}(n,0)},drawCanvas:function(a,b){b.getContext("2d").drawImage(a,0,0)},update:function(a,b,c,d,e){this.startAnimation(this.ctx,a,b,c,d,e)}}),ChoiceView=Backbone.View.extend({initialize:function(){$(".choiceItem.humanFirst").css("color",colors.red),$(".choiceItem.computerFirst").css("color",colors.yellow)},events:{"click .humanFirst":"humanStart","click .computerFirst":"computerStart"},humanStart:function(){dispatcher.trigger("game:restart",0)},computerStart:function(){dispatcher.trigger("game:restart",1)}}),ResultView=Backbone.View.extend({resultBoxClass:"result",loadingBoxClass:"loading",tokens:tokens,initialize:function(){var a=$("<span>",{"class":this.resultBoxClass,css:{visibility:"hidden"}}),b=$("<span>",{"class":this.loadingBoxClass,html:"Loading..",css:{visibility:"hidden"}});this.$el.html(a.add(b)),this.listenTo(dispatcher,"win",this.update),this.listenTo(dispatcher,"loading:start",this.startLoading),this.listenTo(dispatcher,"loading:stop",this.stopLoading),this.listenTo(dispatcher,"game:restart",this.onRestart)},update:function(a){var b=this.tokens[a],c=$("."+this.resultBoxClass);b&&(c.addClass(b).html("Winner is "+b),this.show(c))},onRestart:function(){$("."+this.resultBoxClass).empty()},startLoading:function(){this.show($("."+this.loadingBoxClass))},stopLoading:function(){this.hide($("."+this.loadingBoxClass))},hide:function(a){a.css("visibility","hidden")},show:function(a){a.css("visibility","visible")}}),dispatcher=_.clone(Backbone.Events),game=new Game,player1=new HumanPlayer({index:0}),player2=new ExpertAIPlayer({index:1}),boardView=new BoardView({el:$("#gameCanvas")}),resultView=new ResultView({el:$(".sideBox")}),choiceView=new ChoiceView({el:$(".choiceBox")}),GameRouter=Backbone.Router.extend({routes:{"":"start","local/:index":"start",online:"startOnline"}}),gameRouter=new GameRouter;gameRouter.on("route:start",function(a){dispatcher.trigger("game:restart",parseInt(a))}),gameRouter.on("route:startOnline",function(){console.log("Hello online!!")}),Backbone.history.start();